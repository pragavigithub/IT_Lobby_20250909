{% extends "layout.html" %}

{% block title %}SO Against Invoice - {{ document.document_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-file-invoice"></i> {{ document.document_number }}
                        </h3>
                        <div>
                            {% if document.status == 'draft' %}
                                <span class="badge bg-secondary fs-6">Draft</span>
                            {% elif document.status == 'validated' %}
                                <span class="badge bg-info fs-6">Validated</span>
                            {% elif document.status == 'posted' %}
                                <span class="badge bg-success fs-6">Posted</span>
                            {% elif document.status == 'failed' %}
                                <span class="badge bg-danger fs-6">Failed</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Document Header -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Document Information</h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td width="40%"><strong>Document Number:</strong></td>
                                    <td>{{ document.document_number }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Created By:</strong></td>
                                    <td>{{ document.user.username }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Created At:</strong></td>
                                    <td>{{ document.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>
                                {% if document.sap_invoice_number %}
                                <tr>
                                    <td><strong>SAP Invoice #:</strong></td>
                                    <td><span class="badge bg-success">{{ document.sap_invoice_number }}</span></td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        <div class="col-md-6">
                            {% if document.so_number %}
                            <h6>Sales Order Information</h6>
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td width="40%"><strong>SO Series:</strong></td>
                                    <td>{{ document.so_series_name }} ({{ document.so_series }})</td>
                                </tr>
                                <tr>
                                    <td><strong>SO Number:</strong></td>
                                    <td>{{ document.so_number }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Customer:</strong></td>
                                    <td>
                                        <strong>{{ document.card_code }}</strong><br>
                                        <small>{{ document.card_name }}</small>
                                    </td>
                                </tr>
                                {% if document.customer_address %}
                                <tr>
                                    <td><strong>Address:</strong></td>
                                    <td><small>{{ document.customer_address }}</small></td>
                                </tr>
                                {% endif %}
                            </table>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Workflow Steps -->
                    <div class="mb-4">
                        <h6>Workflow Progress</h6>
                        <div class="row">
                            <div class="col-12">
                                <div class="progress-wrapper">
                                    <div class="progress" style="height: 30px;">
                                        <div class="progress-bar 
                                            {% if document.status == 'draft' %}bg-secondary{% endif %}
                                            {% if document.status == 'validated' %}bg-info{% endif %}
                                            {% if document.status == 'posted' %}bg-success{% endif %}
                                            {% if document.status == 'failed' %}bg-danger{% endif %}"
                                            role="progressbar" 
                                            style="width: 
                                                {% if document.status == 'draft' %}25%{% endif %}
                                                {% if document.status == 'validated' %}75%{% endif %}
                                                {% if document.status == 'posted' %}100%{% endif %}
                                                {% if document.status == 'failed' %}50%{% endif %}">
                                            {% if document.status == 'draft' %}Step 1: Draft Created{% endif %}
                                            {% if document.status == 'validated' %}Step 3: SO Validated{% endif %}
                                            {% if document.status == 'posted' %}Step 5: Invoice Posted{% endif %}
                                            {% if document.status == 'failed' %}Failed{% endif %}
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            Steps: 1. Create → 2. Select SO Series → 3. Validate SO → 4. Validate Items → 5. Post Invoice
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SO Selection (if not selected yet) -->
                    {% if document.status == 'draft' %}
                    <div class="mb-4">
                        <h6>Step 1: Select Sales Order</h6>
                        <div class="card border-primary">
                            <div class="card-body">
                                <form id="soSelectionForm">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="soSeries" class="form-label">SO Series:</label>
                                            <select id="soSeries" class="form-select" required>
                                                <option value="">Loading series...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="soNumber" class="form-label">SO Number:</label>
                                            <input type="text" id="soNumber" class="form-control" 
                                                   placeholder="Enter SO Number" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">&nbsp;</label>
                                            <div>
                                                <button type="button" id="validateSOBtn" class="btn btn-primary">
                                                    <i class="fas fa-search"></i> Validate SO
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                
                                <div id="soValidationResult" class="mt-3" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- SO Details (if validated) -->
                    {% if document.status in ['validated', 'posted'] and document.items %}
                    <div class="mb-4">
                        <h6>Step 2: Sales Order Line Items</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Line #</th>
                                        <th>Item Code</th>
                                        <th>Description</th>
                                        <th>SO Qty</th>
                                        <th>Warehouse</th>
                                        <th>Validated Qty</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in document.items %}
                                    <tr>
                                        <td>{{ item.line_num }}</td>
                                        <td><strong>{{ item.item_code }}</strong></td>
                                        <td>{{ item.item_description }}</td>
                                        <td>{{ item.so_quantity }}</td>
                                        <td>{{ item.warehouse_code }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ item.validated_quantity }}</span>
                                        </td>
                                        <td>
                                            {% if item.validation_status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif item.validation_status == 'validated' %}
                                                <span class="badge bg-success">Validated</span>
                                            {% elif item.validation_status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if document.status == 'validated' %}
                                            <button class="btn btn-sm btn-outline-primary validate-item-btn" 
                                                    data-item-id="{{ item.id }}"
                                                    data-item-code="{{ item.item_code }}"
                                                    data-warehouse="{{ item.warehouse_code }}">
                                                <i class="fas fa-check"></i> Validate
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Post Invoice (if validated) -->
                    {% if document.status == 'validated' %}
                    <div class="mb-4">
                        <h6>Step 3: Post Invoice to SAP B1</h6>
                        <div class="card border-success">
                            <div class="card-body">
                                <p>All line items are validated. Ready to post invoice to SAP B1.</p>
                                <button id="postInvoiceBtn" class="btn btn-success">
                                    <i class="fas fa-paper-plane"></i> Post Invoice to SAP B1
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Error Display -->
                    {% if document.posting_error %}
                    <div class="mb-4">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle"></i> Posting Error:</h6>
                            <pre>{{ document.posting_error }}</pre>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('so_against_invoice.index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </a>
                        {% if document.status == 'posted' and document.sap_invoice_number %}
                        <button class="btn btn-success" disabled>
                            <i class="fas fa-check"></i> Invoice Posted: {{ document.sap_invoice_number }}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Item Validation Modal -->
<div class="modal fade" id="itemValidationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Validate Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="itemValidationForm">
                    <input type="hidden" id="modalItemId">
                    <input type="hidden" id="modalItemCode">
                    <input type="hidden" id="modalWarehouse">
                    
                    <div class="mb-3">
                        <label class="form-label">Item Type:</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="itemType" id="serialType" value="serial" checked>
                                <label class="form-check-label" for="serialType">Serial Managed</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="itemType" id="nonSerialType" value="non_serial">
                                <label class="form-check-label" for="nonSerialType">Non-Serial</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="serialNumberSection">
                        <div class="mb-3">
                            <label for="serialNumber" class="form-label">Serial Number:</label>
                            <input type="text" id="serialNumber" class="form-control" 
                                   placeholder="Enter serial number">
                        </div>
                    </div>
                    
                    <div id="quantitySection" style="display: none;">
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity:</label>
                            <input type="number" id="quantity" class="form-control" 
                                   placeholder="Enter quantity" min="1" value="1">
                        </div>
                    </div>
                </form>
                
                <div id="validationResult" class="mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="validateItemModalBtn" class="btn btn-primary">Validate</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const docId = {{ document.id }};
    
    // Load SO Series when page loads
    {% if document.status == 'draft' %}
    loadSOSeries();
    {% endif %}
    
    // SO Series loading
    function loadSOSeries() {
        fetch('/so-against-invoice/api/get-so-series')
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('soSeries');
                select.innerHTML = '<option value="">Select SO Series</option>';
                
                if (data.success) {
                    data.series.forEach(series => {
                        const option = document.createElement('option');
                        option.value = series.Series;
                        option.textContent = `${series.SeriesName} (${series.Series})`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Error loading series</option>';
                }
            })
            .catch(error => {
                console.error('Error loading SO series:', error);
                document.getElementById('soSeries').innerHTML = '<option value="">Error loading series</option>';
            });
    }
    
    // SO Validation
    document.getElementById('validateSOBtn')?.addEventListener('click', function() {
        const soSeries = document.getElementById('soSeries').value;
        const soNumber = document.getElementById('soNumber').value;
        
        if (!soSeries || !soNumber) {
            alert('Please select SO Series and enter SO Number');
            return;
        }
        
        // Step 1: Validate SO Number with Series
        fetch('/so-against-invoice/api/validate-so-number', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ so_number: soNumber, series: soSeries })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Step 2: Fetch SO Details
                return fetch('/so-against-invoice/api/fetch-so-details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ doc_entry: data.doc_entry })
                });
            } else {
                throw new Error(data.error);
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Step 3: Save SO Details
                const seriesSelect = document.getElementById('soSeries');
                const selectedOption = seriesSelect.options[seriesSelect.selectedIndex];
                
                return fetch('/so-against-invoice/api/save-so-details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doc_id: docId,
                        so_details: {
                            so_number: soNumber,
                            doc_entry: data.order.DocEntry,
                            order: data.order
                        },
                        series_info: {
                            series: soSeries,
                            series_name: selectedOption.textContent.split(' (')[0]
                        }
                    })
                });
            } else {
                throw new Error(data.error);
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload page to show updated SO details
                window.location.reload();
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            document.getElementById('soValidationResult').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
            document.getElementById('soValidationResult').style.display = 'block';
        });
    });
    
    // Item type radio buttons
    document.querySelectorAll('input[name="itemType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const serialSection = document.getElementById('serialNumberSection');
            const quantitySection = document.getElementById('quantitySection');
            
            if (this.value === 'serial') {
                serialSection.style.display = 'block';
                quantitySection.style.display = 'none';
                document.getElementById('quantity').value = 1;
            } else {
                serialSection.style.display = 'none';
                quantitySection.style.display = 'block';
                document.getElementById('serialNumber').value = '';
            }
        });
    });
    
    // Item validation buttons
    document.querySelectorAll('.validate-item-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const itemCode = this.dataset.itemCode;
            const warehouse = this.dataset.warehouse;
            
            document.getElementById('modalItemId').value = itemId;
            document.getElementById('modalItemCode').value = itemCode;
            document.getElementById('modalWarehouse').value = warehouse;
            
            // Reset form
            document.getElementById('serialType').checked = true;
            document.getElementById('serialNumberSection').style.display = 'block';
            document.getElementById('quantitySection').style.display = 'none';
            document.getElementById('serialNumber').value = '';
            document.getElementById('quantity').value = 1;
            document.getElementById('validationResult').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('itemValidationModal'));
            modal.show();
        });
    });
    
    // Modal validation
    document.getElementById('validateItemModalBtn')?.addEventListener('click', function() {
        const itemType = document.querySelector('input[name="itemType"]:checked').value;
        const itemCode = document.getElementById('modalItemCode').value;
        const warehouse = document.getElementById('modalWarehouse').value;
        const serialNumber = document.getElementById('serialNumber').value;
        const quantity = document.getElementById('quantity').value;
        
        const requestData = {
            item_code: itemCode,
            warehouse_code: warehouse,
            item_type: itemType
        };
        
        if (itemType === 'serial') {
            if (!serialNumber) {
                alert('Please enter serial number');
                return;
            }
            requestData.serial_number = serialNumber;
        } else {
            if (!quantity || quantity < 1) {
                alert('Please enter valid quantity');
                return;
            }
            requestData.quantity = parseInt(quantity);
        }
        
        fetch('/so-against-invoice/api/validate-item', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('validationResult');
            
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check"></i> ${data.message}
                        ${data.offline_mode ? ' <span class="badge bg-warning">Offline Mode</span>' : ''}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> ${data.error}
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
        })
        .catch(error => {
            document.getElementById('validationResult').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
            document.getElementById('validationResult').style.display = 'block';
        });
    });
    
    // Post invoice
    document.getElementById('postInvoiceBtn')?.addEventListener('click', function() {
        if (!confirm('Are you sure you want to post this invoice to SAP B1?')) {
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
        
        fetch('/so-against-invoice/api/post-invoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ doc_id: docId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Invoice posted successfully! SAP DocNum: ${data.sap_doc_num}`);
                window.location.reload();
            } else {
                alert(`Error posting invoice: ${data.error}`);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-paper-plane"></i> Post Invoice to SAP B1';
            }
        })
        .catch(error => {
            alert(`Error posting invoice: ${error.message}`);
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-paper-plane"></i> Post Invoice to SAP B1';
        });
    });
});
</script>
{% endblock %}